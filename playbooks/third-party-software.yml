---
###########################################################
#        Martin O'Flaherty: Third Party Software          #
###########################################################
# Version History:
# 0.28 - Added Flatpak audit for Bitwarden and qBittorrent
#        Ensures 'latest' state and removes legacy .debs
# 0.08 - Added cleanup of legacy Docker repo files to
#        prevent Signed-By conflicts
# 0.07 - Fixed 'ubuntu_codename' undefined error by
#        moving fact-gathering to the top
###########################################################

# =============================================================================
# CODENAME DISCOVERY
# =============================================================================

- name: Get Ubuntu base codename for Linux Mint
  shell: "grep CODENAME /etc/upstream-release/lsb-release | cut -d= -f2"
  register: mint_ubuntu_base
  changed_when: false
  when: ansible_distribution == "Linux Mint"

- name: Set Ubuntu codename variable for Linux Mint
  set_fact:
    ubuntu_codename: "{{ mint_ubuntu_base.stdout }}"
  when: ansible_distribution == "Linux Mint"

- name: Set Ubuntu codename variable for Ubuntu
  set_fact:
    ubuntu_codename: "{{ ansible_distribution_release }}"
  when: ansible_distribution == "Ubuntu"

# =============================================================================
# GOOGLE CHROME (localhost/Minty only)
# =============================================================================

- name: Add Google Chrome GPG key
  ansible.builtin.get_url:
    url: https://dl.google.com/linux/linux_signing_key.pub
    dest: /usr/share/keyrings/google-chrome-keyring.asc
    mode: '0644'
  when:
    - ansible_architecture == "x86_64"
    - inventory_hostname == "localhost"

- name: Add Google Chrome repository
  apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome-keyring.asc] http://dl.google.com/linux/chrome/deb/ stable main"
    state: present
    filename: google-chrome
  when:
    - ansible_architecture == "x86_64"
    - inventory_hostname == "localhost"

- name: Install Google Chrome
  package:
    name: google-chrome-stable
    state: present
  when:
    - ansible_architecture == "x86_64"
    - inventory_hostname == "localhost"

# =============================================================================
# DOCKER (x86_64 only)
# =============================================================================

- name: Purge conflicting Ubuntu-native container packages
  apt:
    name:
      - docker.io
      - docker-doc
      - docker-compose
      - containerd
      - runc
    state: absent
    purge: yes
  when: ansible_architecture == "x86_64"

- name: Remove legacy Docker repository files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/docker.list
    - /etc/apt/keyrings/docker.asc
  when: ansible_architecture == "x86_64"

- name: Add Docker GPG key
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/ubuntu/gpg
    dest: /usr/share/keyrings/docker-keyring.asc
    mode: '0644'
  when: ansible_architecture == "x86_64"

- name: Add Docker repository
  apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-keyring.asc] https://download.docker.com/linux/ubuntu {{ ubuntu_codename }} stable"
    state: present
    filename: docker
  when:
    - ansible_architecture == "x86_64"
    - ubuntu_codename is defined

- name: Install official Docker Engine
  apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-compose-plugin
    state: present
    update_cache: yes
  when: ansible_architecture == "x86_64"

# =============================================================================
# FLATPAK SOFTWARE (localhost/Minty only)
# =============================================================================

- name: Ensure Flatpak is installed
  package:
    name: flatpak
    state: present
  when: inventory_hostname == "localhost"

- name: Add Flathub repository
  community.general.flatpak_remote:
    name: flathub
    state: present
    flatpakrepo_url: https://dl.flathub.org/repo/flathub.flatpakrepo
  when: inventory_hostname == "localhost"

- name: Install latest Flatpak applications
  community.general.flatpak:
    name:
      - com.bitwarden.desktop
      - org.qbittorrent.qBittorrent
    state: latest
    remote: flathub
  when: inventory_hostname == "localhost"

- name: Remove native .deb versions to prevent duplicates
  apt:
    name:
      - bitwarden
      - qbittorrent
    state: absent
    purge: yes
  when: inventory_hostname == "localhost"
