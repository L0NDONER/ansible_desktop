---
###########################################################
#        Martin O'Flaherty: Fleet Maintenance             #
###########################################################
# Version History:
# 0.10 - 0.18: Consolidated fleet reporting
# 0.19 - Added Global Health Artifact generation
# 0.20 - Integrated pretty-uptime for Fleet Dashboard
# 0.21 - Added Auto-Healing VPN logic (Azure & AWS)
###########################################################

- name: System Maintenance and Updates
  hosts: all
  become: yes
  
  vars_files:
    - group_vars/all.yml

  tasks:
    - name: Main Fleet Update Block
      block:
        # --- INFRASTRUCTURE & MAINTENANCE ---
        - name: Apply SSH Hardening and Banners
          include_tasks: ssh_harden.yml
          when: inventory_hostname != 'az'

        # --- AUTO-HEALING VPN LOGIC (v0.21) ---
        - name: VPN Tunnel Pulse Check
          # Pings the internal gateway; works for both Azure and AWS tunnels
          shell: ping -c 2 10.8.0.1
          register: vpn_ping
          ignore_errors: yes
          changed_when: false
          when: "inventory_hostname in ['az', 'aws']"

        - name: Set VPN Healing Flag
          set_fact:
            needs_vpn_heal: "{{ vpn_ping.rc != 0 }}"
          when: "inventory_hostname in ['az', 'aws']"

        - name: Auto-Heal Azure VPN
          include_tasks: azure_vpn_maintenance.yml
          when: 
            - inventory_hostname == 'az'
            - needs_vpn_heal | default(false)

        - name: Auto-Heal AWS VPN
          include_tasks: aws_vpn_maintenance.yml
          when: 
            - inventory_hostname == 'aws'
            - needs_vpn_heal | default(false)

        # --- STANDARD MAINTENANCE ---
        - name: Install Third Party Software
          include_tasks: third-party-software.yml

        - name: Run System Updates
          include_tasks: update.yml

        - name: Check for Reboot
          stat:
            path: /var/run/reboot-required
          register: reboot_required_file

        - name: Reboot if required
          reboot:
            msg: "Rebooting for system updates"
            reboot_timeout: 3600
          when: reboot_required_file.stat.exists

        # --- GLOBAL HEALTH ARTIFACT GENERATION (v0.21) ---
        - name: Generate Health Artifact
          shell: |
            ping -c 1 8.8.8.8 > /dev/null 2>&1 && NET="ğŸŸ¢" || NET="ğŸ”´"
            if command -v docker >/dev/null; then
              docker ps > /dev/null 2>&1 && DOCKER="ğŸ³" || DOCKER="ğŸš«"
            else
              DOCKER="âŒ"
            fi
            # Add VPN healing status icon (ğŸ©¹) to the dashboard data
            HEAL="{{ needs_vpn_heal | default(false) | ternary('ğŸ©¹', '') }}"
            UPTIME=$(uptime -p | sed 's/up //')
            echo "{\"net\": \"$NET\", \"docker\": \"$DOCKER $HEAL\", \"time\": \"$(date +%H:%M)\", \"uptime\": \"$UPTIME\"}"
          register: health_out
          changed_when: false

        - name: Save Health JSON
          copy:
            content: "{{ health_out.stdout }}"
            dest: /tmp/fleet_health.json

      rescue:
        - name: Send Failure WhatsApp
          community.general.twilio:
            account_sid: "{{ twilio_sid }}"
            auth_token: "{{ tw_auth_k }}"
            from_number: "whatsapp:{{ twilio_from_number }}"
            to_number: "whatsapp:{{ my_mobile_number }}"
            msg: |
              ğŸš¨ *Ansible Fleet ALERT*
              ğŸ–¥ï¸ *Host:* {{ inventory_hostname }}
              âŒ *Status:* FAILED
          delegate_to: localhost
          when: not ansible_check_mode

    - name: Send Consolidated Success WhatsApp
      community.general.twilio:
        account_sid: "{{ twilio_sid }}"
        auth_token: "{{ tw_auth_k }}"
        from_number: "whatsapp:{{ twilio_from_number }}"
        to_number: "whatsapp:{{ my_mobile_number }}"
        msg: |
          ğŸ¬ *Ansible Fleet Update Complete*
          âœ… *Status:* Smooth as butter.
          {% set healed = [] %}
          {% for host in ansible_play_hosts_all %}
          {%   if hostvars[host].needs_vpn_heal | default(false) %}
          {%     set _ = healed.append(host) %}
          {%   endif %}
          {% endfor %}
          {% if healed %}
          ğŸ©¹ *Note:* VPN healed on {{ healed | join(', ') }}
          {% endif %}
          ğŸ“‹ *Version:* 0.21 auto-heal module
      delegate_to: localhost
      run_once: true
      when: not ansible_check_mode

  handlers:
    - name: restart sshd
      service:
        name: ssh
        state: restarted
