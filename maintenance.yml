---
###########################################################
#        Martin O'Flaherty: Fleet Maintenance             #
###########################################################
# Version History:
# 0.10 - 0.21: Initial logic and consolidated reporting
# 0.22 - 0.24: Pathing fixes and absolute paths
# 0.25: Added security audit (SSH knock count)
# 0.26: Added Fail2Ban jail count
# 0.27: Fleet-wide security summary in completion notification
# 0.28: Integrated Flatpak audit for desktop apps
###########################################################

- name: System maintenance and updates
  hosts: all
  become: yes

  tasks:
    # ==========================================================================
    # MAIN FLEET UPDATE BLOCK
    # ==========================================================================
    - name: Main fleet update block
      block:
        # ----------------------------------------------------------------------
        # Infrastructure & Maintenance
        # ----------------------------------------------------------------------
        - name: Apply SSH hardening and banners
          include_tasks: "{{ playbook_dir }}/ssh_harden.yml"
          when: inventory_hostname != 'az'

        # ----------------------------------------------------------------------
        # Auto-healing VPN logic
        # ----------------------------------------------------------------------
        - name: VPN tunnel pulse check
          shell: ping -c 2 10.8.0.1
          register: vpn_ping
          ignore_errors: yes
          changed_when: false
          when: inventory_hostname in ['az', 'aws']

        - name: Set VPN healing flag
          set_fact:
            needs_vpn_heal: "{{ vpn_ping.rc != 0 }}"
          when: inventory_hostname in ['az', 'aws']

        - name: Auto-heal Azure VPN
          include_tasks: "{{ playbook_dir }}/azure_vpn_maintenance.yml"
          when:
            - inventory_hostname == 'az'
            - needs_vpn_heal | default(false)

        - name: Auto-heal AWS VPN
          include_tasks: "{{ playbook_dir }}/aws_vpn_maintenance.yml"
          when:
            - inventory_hostname == 'aws'
            - needs_vpn_heal | default(false)

        # ----------------------------------------------------------------------
        # Standard maintenance
        # ----------------------------------------------------------------------
        - name: Install third party software
          include_tasks: "{{ playbook_dir }}/third-party-software.yml"

        - name: Run system updates
          include_tasks: "{{ playbook_dir }}/update.yml"

        - name: Check for reboot requirement
          stat:
            path: /var/run/reboot-required
          register: reboot_required_file

        - name: Reboot if required
          reboot:
            msg: "Rebooting for system updates"
            reboot_timeout: 3600
          when: reboot_required_file.stat.exists

        # ----------------------------------------------------------------------
        # Security audit
        # ----------------------------------------------------------------------
        - name: Count failed SSH attempts (today)
          shell: "grep 'Failed password' /var/log/auth.log | grep \"$(date +'%b %e')\" | wc -l"
          register: ssh_knocks
          ignore_errors: yes
          changed_when: false

        - name: Count active Fail2Ban jails
          shell: "fail2ban-client status sshd | grep 'Currently banned:' | awk '{print $4}'"
          register: jail_count
          ignore_errors: yes
          changed_when: false

        # ----------------------------------------------------------------------
        # Global health artifact generation
        # ----------------------------------------------------------------------
        - name: Generate health artifact
          shell: |
            ping -c 1 8.8.8.8 > /dev/null 2>&1 && NET="ğŸŸ¢" || NET="ğŸ”´"
            if command -v docker >/dev/null; then
              docker ps > /dev/null 2>&1 && DOCKER="ğŸ³" || DOCKER="ğŸš«"
            else
              DOCKER="âŒ€"
            fi
            HEAL="{{ needs_vpn_heal | default(false) | ternary('ğŸ©¹', '') }}"
            UPTIME=$(uptime -p | sed 's/up //')
            KNOCKS="{{ ssh_knocks.stdout | trim | default('0') }}"
            JAILS="{{ jail_count.stdout | trim | default('0') }}"
            echo "{\"net\": \"$NET\", \"docker\": \"$DOCKER $HEAL\", \"time\": \"$(date +%H:%M)\", \"uptime\": \"$UPTIME\", \"knocks\": \"$KNOCKS\", \"jails\": \"$JAILS\"}"
          register: health_out
          changed_when: false

        - name: Save health JSON
          copy:
            content: "{{ health_out.stdout }}"
            dest: /tmp/fleet_health.json

      rescue:
        - name: Send failure WhatsApp notification
          community.general.twilio:
            account_sid: "{{ twilio_sid }}"
            auth_token: "{{ tw_auth_k }}"
            from_number: "whatsapp:{{ twilio_from_number }}"
            to_number: "whatsapp:{{ my_mobile_number }}"
            msg: |
              ğŸš¨ *Ansible Fleet ALERT*
              ğŸ–¥ï¸ *Host:* {{ inventory_hostname }}
              âŒ *Status:* FAILED
              ğŸ“ *Note:* Check logs on {{ inventory_hostname }}
          delegate_to: localhost
          when: not ansible_check_mode

    # ==========================================================================
    # CONSOLIDATED SUCCESS NOTIFICATION
    # ==========================================================================
    - name: Send consolidated success WhatsApp notification
      community.general.twilio:
        account_sid: "{{ twilio_sid }}"
        auth_token: "{{ tw_auth_k }}"
        from_number: "whatsapp:{{ twilio_from_number }}"
        to_number: "whatsapp:{{ my_mobile_number }}"
        msg: |
          ğŸ¬ *Ansible Fleet Update Complete*
          âœ… *Status:* Smooth as butter
          ğŸ›¡ï¸ *Security:* {{ groups['all'] | map('extract', hostvars, 'ssh_knocks') | map(attribute='stdout', default='0') | map('int') | sum }} knocks | {{ groups['all'] | map('extract', hostvars, 'jail_count') | map(attribute='stdout', default='0') | map('int') | sum }} jailed
          ğŸ“‹ *Version:* 0.28 (Audit Integrated)
      delegate_to: localhost
      run_once: true
      when: not ansible_check_mode

  # ============================================================================
  # HANDLERS
  # ============================================================================
  handlers:
    - name: restart sshd
      service:
        name: ssh
        state: restarted
